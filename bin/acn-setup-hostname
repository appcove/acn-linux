#!/usr/bin/python3.5
# vim:encoding=utf-8:ts=2:sw=2:expandtab
import mmap
from acnpython35 import *

try:
  print()
  if not exists('/etc/.git'):
    print('WARNING: /etc not tracked by .git. Please abort and run `acn-setup-etcgit`.')
    print()
  
  print("hostname is: ", end='')
  sys.stdout.flush()
  call(('/bin/hostname'))
  print()
  
  if not GetInput_YesNo("Do you want to set the hostname (yes)? ", Default='yes'):
    sys.exit(0)
  
  hostname = GetInput_Regex("Enter the hostname: ", Regex='^[a-zA-Z0-9-.]+$')
  check_call(('/bin/hostname', hostname))

  sysconfigfile = open('/etc/sysconfig/network')
  hosts = mmap.mmap(sysconfigfile.fileno(), 0, access=mmap.ACCESS_READ)
  
  if 'HOSTNAME' in hosts:
    check_call(('/bin/sed', '--in-place', 's/^HOSTNAME=.*/HOSTNAME=%s/' % hostname, '/etc/sysconfig/network'))
    print()  
    print("New contents of /etc/syconfig/network:")
    print("---")
    call(("cat", "/etc/sysconfig/network"))
    print("---")
    print()
  else:
    doc = open('/etc/sysconfig/network', 'a')
    doc.write('HOSTNAME=%s'%hostname)    

except Exception as e:
  print()
  print()
  print('*** Fatal Error ***')
  print(e)
  print()
except KeyboardInterrupt:
  print()  
  print()
  print('*** User Abort ***')
  print()

